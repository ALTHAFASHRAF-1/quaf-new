<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin – Google Sheet Editor</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#121a33; --panel2:#0f1630;
      --text:#e9ecff; --muted:#a8b0d6; --border:rgba(255,255,255,.12);
      --accent:#6aa6ff; --good:#7cdbb6; --bad:#ff6a6a;
      --mono: ui-monospace,Consolas,monospace;
    }
    body{margin:0;font-family:system-ui,Arial;background:var(--bg);color:var(--text)}
    .wrap{max-width:1400px;margin:22px auto;padding:0 14px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;overflow:hidden}
    .bar{padding:12px;border-bottom:1px solid var(--border);display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,select,button,textarea{
      padding:10px 12px;border-radius:10px;border:1px solid var(--border);
      background:var(--panel2);color:var(--text);outline:none
    }
    button{cursor:pointer;background:#1a2450}
    button.primary{background:linear-gradient(135deg,var(--accent),var(--good));border:0;color:#071024;font-weight:800}
    button.danger{border-color:rgba(255,106,106,.35);background:rgba(255,106,106,.10)}
    .grid{display:grid;grid-template-columns: 1fr 420px;gap:12px;padding:12px}
    @media(max-width:1100px){ .grid{grid-template-columns:1fr} }
    .panel{background:rgba(0,0,0,.16);border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .panel h3{margin:0;padding:10px 12px;border-bottom:1px solid var(--border);font-size:14px}
    .panel .body{padding:12px}
    .status{padding:10px 12px;border-top:1px solid var(--border);color:var(--muted);font-size:12px}
    .muted{color:var(--muted);font-size:12px}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:rgba(0,0,0,.12)}
    .tableWrap{overflow:auto;max-height:72vh;border:1px solid rgba(255,255,255,.08);border-radius:10px}
    table{border-collapse:collapse;width:max-content;min-width:100%}
    th,td{border:1px solid rgba(255,255,255,.08);padding:7px 10px;font-size:12.5px;white-space:nowrap}
    th{position:sticky;top:0;background:rgba(15,22,48,.95);z-index:2}
    td{background:rgba(15,22,48,.55);cursor:pointer}
    td:hover{outline:2px solid rgba(106,166,255,.35)}
    td.selected{outline:2px solid rgba(124,219,182,.7); background:rgba(124,219,182,.12)}
    textarea{width:100%;min-height:90px;font-family:var(--mono);font-size:12px}
    .btnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .changes{font-family:var(--mono);font-size:12px;max-height:180px;overflow:auto;background:rgba(0,0,0,.12);border:1px solid rgba(255,255,255,.10);border-radius:10px;padding:10px}
  </style>
</head>
<body>
<div class="wrap">
  <h2>Admin – Edit Google Sheet Data (Merged-safe)</h2>

  <div class="card">
    <div class="bar">
      <input id="webapp" style="flex:1;min-width:320px" placeholder="Paste Web App URL (ends with /exec)"/>
      <input id="adminkey" style="width:300px" placeholder="Admin key (same as ADMIN_KEY)"/>
      <button class="primary" onclick="loadAll()">Load</button>

      <span class="pill">Sheet:
        <select id="sheetSel" onchange="renderSheet()"></select>
      </span>

      <button onclick="reloadCurrent()">Reload Sheet</button>
    </div>

    <div class="grid">
      <div class="panel">
        <h3>Sheet Grid (click a cell to edit)</h3>
        <div class="body">
          <div class="muted" id="meta"></div>
          <div class="tableWrap">
            <table id="grid"></table>
          </div>
        </div>
        <div class="status" id="status">Idle</div>
      </div>

      <div class="panel">
        <h3>Edit Cell</h3>
        <div class="body">
          <div class="muted" id="cellInfo">No cell selected.</div>

          <div style="margin-top:10px">
            <label class="muted">Value</label>
            <textarea id="cellValue" placeholder="Type new value..."></textarea>
          </div>

          <div class="btnRow">
            <button class="primary" onclick="saveCell()">Save Cell</button>
            <button onclick="queueChange()">Queue Change</button>
            <button class="primary" onclick="saveAllQueued()">Save All Queued</button>
            <button class="danger" onclick="clearQueue()">Clear Queue</button>
          </div>

          <div style="margin-top:12px">
            <div class="muted">Queued updates (batch):</div>
            <div class="changes" id="queueBox">[]</div>
          </div>

          <div class="muted" style="margin-top:10px">
            Note: Formula cells are displayed but you should not edit them. The UI marks them as read-only.
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  window.addEventListener("load", () => {
  // If hosted inside Apps Script, this is the same origin endpoint:
  document.getElementById("webapp").value = window.location.origin + window.location.pathname;
});

  let payload = null;
  let currentSheet = null;
  let selected = { sheet:null, row:null, col:null, isFormula:false };
  let queued = []; // {row,col,value}

  function setStatus(t){ document.getElementById('status').textContent = t; }
  function setMeta(t){ document.getElementById('meta').textContent = t; }

  // JSONP callback used by Apps Script
  function showAll(data){
    payload = data;
    setStatus("Loaded");
    fillSheetSelect();
    renderSheet();
  }

  function loadAll(){
    const base = document.getElementById('webapp').value.trim();
    if(!base){ setStatus("Paste Web App URL"); return; }

    setStatus("Loading...");
    document.getElementById("jsonp")?.remove();

    const src = base + (base.includes("?") ? "&" : "?") + "action=all&format=pretty&callback=showAll";
    const s = document.createElement("script");
    s.id = "jsonp";
    s.src = src;
    s.onerror = () => setStatus("Failed to load. Check deploy access + URL.");
    document.body.appendChild(s);
  }

  function fillSheetSelect(){
    const sel = document.getElementById('sheetSel');
    sel.innerHTML = "";
    const sheets = payload?.schema?.sheets || [];
    sheets.forEach(sh => {
      const opt = document.createElement("option");
      opt.value = sh.name;
      opt.textContent = sh.name;
      sel.appendChild(opt);
    });
  }

  function getSheetDataByName(name){
    return (payload?.data?.sheets || []).find(s => s.name === name);
  }

  function renderSheet(){
    clearSelection();
    const name = document.getElementById('sheetSel').value;
    currentSheet = name;

    const sd = getSheetDataByName(name);
    const grid = document.getElementById('grid');
    grid.innerHTML = "";

    if(!sd || !sd.usedRange){
      setMeta("No data / empty sheet.");
      grid.innerHTML = "<tr><td>No data</td></tr>";
      return;
    }

    const dv = sd.displayValues || [];
    const fm = sd.formulas || [];
    setMeta(`Sheet: ${name} | Used range: ${sd.usedRange.a1Notation} | Rows: ${dv.length} | Cols: ${(dv[0]||[]).length}`);

    // Build header row: column numbers
    const thead = document.createElement("thead");
    const trh = document.createElement("tr");
    const corner = document.createElement("th");
    corner.textContent = "#";
    trh.appendChild(corner);

    const cols = (dv[0]||[]).length;
    for(let c=1;c<=cols;c++){
      const th = document.createElement("th");
      th.textContent = c;
      trh.appendChild(th);
    }
    thead.appendChild(trh);
    grid.appendChild(thead);

    // Body rows
    const tbody = document.createElement("tbody");
    for(let r=1;r<=dv.length;r++){
      const tr = document.createElement("tr");
      const th = document.createElement("th");
      th.textContent = r;
      tr.appendChild(th);

      for(let c=1;c<=cols;c++){
        const td = document.createElement("td");
        const val = (dv[r-1] && dv[r-1][c-1]) ? dv[r-1][c-1] : "";
        const isFormula = (fm[r-1] && fm[r-1][c-1]) ? true : false;

        td.textContent = val;
        if(isFormula){
          td.style.opacity = "0.65";
          td.title = "Formula cell (read-only): " + fm[r-1][c-1];
        }
        td.onclick = () => selectCell(name, r, c, val, isFormula, td);
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }
    grid.appendChild(tbody);
  }

  function clearSelection(){
    document.querySelectorAll("td.selected").forEach(el => el.classList.remove("selected"));
    selected = { sheet:null, row:null, col:null, isFormula:false };
    document.getElementById('cellInfo').textContent = "No cell selected.";
    document.getElementById('cellValue').value = "";
  }

  function selectCell(sheet, row, col, val, isFormula, tdEl){
    document.querySelectorAll("td.selected").forEach(el => el.classList.remove("selected"));
    tdEl.classList.add("selected");
    selected = { sheet, row, col, isFormula };

    document.getElementById('cellInfo').textContent =
      `Selected: ${sheet}  R${row}C${col}` + (isFormula ? "  (formula cell: read-only)" : "");

    document.getElementById('cellValue').value = val || "";
  }

  async function saveCell(){
    const base = document.getElementById('webapp').value.trim();
    const key  = document.getElementById('adminkey').value.trim();
    if(!base){ setStatus("Missing Web App URL"); return; }
    if(!key){ setStatus("Missing admin key"); return; }
    if(!selected.sheet){ setStatus("Select a cell first"); return; }
    if(selected.isFormula){ setStatus("This is a formula cell (do not edit)"); return; }

    const value = document.getElementById('cellValue').value;

    setStatus("Saving cell...");
    try{
      const res = await fetch(base, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          key,
          action:"setCell",
          sheet:selected.sheet,
          row:selected.row,
          col:selected.col,
          value
        })
      });

      const json = await res.json();
      if(!json.ok){
        setStatus("Save failed: " + (json.error || "unknown"));
        return;
      }
      setStatus("Saved (merged-safe). Reloading...");
      await reloadCurrent(true);
    }catch(err){
      setStatus("Error: " + err.message);
    }
  }

  function queueChange(){
    if(!selected.sheet){ setStatus("Select a cell first"); return; }
    if(selected.isFormula){ setStatus("Formula cell (read-only)"); return; }
    const value = document.getElementById('cellValue').value;

    queued.push({ row:selected.row, col:selected.col, value });
    document.getElementById('queueBox').textContent = JSON.stringify(queued, null, 2);
    setStatus("Queued " + queued.length + " change(s).");
  }

  function clearQueue(){
    queued = [];
    document.getElementById('queueBox').textContent = "[]";
    setStatus("Queue cleared.");
  }

  async function saveAllQueued(){
    const base = document.getElementById('webapp').value.trim();
    const key  = document.getElementById('adminkey').value.trim();
    if(!base){ setStatus("Missing Web App URL"); return; }
    if(!key){ setStatus("Missing admin key"); return; }
    if(!currentSheet){ setStatus("No sheet selected"); return; }
    if(queued.length === 0){ setStatus("Queue empty"); return; }

    setStatus("Saving batch...");
    try{
      const res = await fetch(base, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          key,
          action:"setCells",
          sheet: currentSheet,
          updates: queued
        })
      });

      const json = await res.json();
      if(!json.ok){
        setStatus("Batch save failed: " + (json.error || "unknown"));
        return;
      }

      setStatus("Batch saved (merged-safe). Reloading...");
      clearQueue();
      await reloadCurrent(true);
    }catch(err){
      setStatus("Error: " + err.message);
    }
  }

  async function reloadCurrent(force=false){
    // easiest: just reload all (keeps code simple)
    // you can optimize later to load only one sheet
    if(force) clearSelection();
    loadAll();
  }
</script>
</body>
</html>
